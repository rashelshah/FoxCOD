{% comment %}
  COD Form Block - Cash on Delivery Order Form
  Hides original Buy buttons and replaces with COD button in the same position
{% endcomment %}

{% schema %}
{
  "name": "COD Order Form",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "button_text",
      "label": "Submit Button Text",
      "default": "Place Order (COD)"
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Primary Color",
      "default": "#667eea"
    },
    {
      "type": "range",
      "id": "max_quantity",
      "min": 1,
      "max": 100,
      "step": 1,
      "label": "Maximum Quantity",
      "default": 10
    },
    {
      "type": "checkbox",
      "id": "require_name",
      "label": "Require Name",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "require_phone",
      "label": "Require Phone",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "require_address",
      "label": "Require Address",
      "default": true
    }
  ]
}
{% endschema %}

{% comment %} Get product and variant info {% endcomment %}
{% assign current_variant = product.selected_or_first_available_variant %}
{% assign product_price = current_variant.price | money_without_trailing_zeros %}


{% comment %} Read COD settings from metafields (synced from app dashboard) {% endcomment %}
{% assign cod_enabled = shop.metafields.fox_cod.enabled | default: 'false' %}
{% assign cod_button_text = shop.metafields.fox_cod.button_text | default: 'Buy with COD' %}
{% assign cod_primary_color = shop.metafields.fox_cod.primary_color | default: '#667eea' %}
{% assign cod_app_url = shop.metafields.fox_cod.app_url | default: '' %}
{% assign cod_max_quantity = shop.metafields.fox_cod.max_quantity | default: 10 %}
{% assign cod_form_title = shop.metafields.fox_cod.form_title | default: 'Cash on Delivery' %}
{% assign cod_form_subtitle = shop.metafields.fox_cod.form_subtitle | default: '' %}
{% assign cod_button_style = shop.metafields.fox_cod.button_style | default: 'solid' %}
{% assign cod_button_size = shop.metafields.fox_cod.button_size | default: 'large' %}
{% assign cod_border_radius = shop.metafields.fox_cod.border_radius | default: 12 %}
{% assign cod_show_product_image = shop.metafields.fox_cod.show_product_image | default: 'true' %}
{% assign cod_show_price = shop.metafields.fox_cod.show_price | default: 'true' %}
{% assign cod_modal_style = shop.metafields.fox_cod.modal_style | default: 'modern' %}
{% assign cod_anim_style = shop.metafields.fox_cod.animation_style | default: 'fade' %}

{% comment %} Advanced JSON Settings {% endcomment %}
{% assign cod_form_type = shop.metafields.fox_cod.form_type | default: 'popup' %}
{% assign cod_fields = shop.metafields.fox_cod.fields | default: '[]' %}
{% assign cod_blocks = shop.metafields.fox_cod.blocks | default: '{}' %}
{% assign cod_custom_fields = shop.metafields.fox_cod.custom_fields | default: '[]' %}
{% assign cod_styles = shop.metafields.fox_cod.styles | default: '{}' %}
{% assign btn_styles_raw = shop.metafields.fox_cod.button_styles_json.value %}
{% assign btn_styles = btn_styles_raw | parse_json %}
{% assign cod_shipping_options = shop.metafields.fox_cod.shipping_options | default: '{}' %}

{% comment %} Partial COD Settings {% endcomment %}
{% assign cod_partial_enabled = shop.metafields.fox_cod.partial_cod_enabled | default: 'false' %}
{% assign cod_partial_advance = shop.metafields.fox_cod.partial_cod_advance_amount | default: '100' %}

{% comment %} Only render COD functionality if enabled in the app {% endcomment %}
{% if cod_enabled == 'true' %}

{% comment %} Container for COD form data - hidden, used by JavaScript {% endcomment %}
<div class="cod-form-data" 
     id="cod-data-{{ product.id }}"
     style="display: none;"
     data-product-id="{{ product.id }}"
     data-variant-id="{{ current_variant.id }}"
     data-product-title="{{ product.title | escape }}"
     data-product-price="{{ current_variant.price | divided_by: 100.0 }}"
     data-shop="{{ shop.permanent_domain }}"
     data-app-url="{{ cod_app_url }}"
     data-max-quantity="{{ cod_max_quantity }}"
     data-button-text="{{ cod_button_text }}"
     data-primary-color="{{ cod_primary_color }}"
     data-form-type="{{ cod_form_type }}"
     data-fields="{{ cod_fields | escape }}"
     data-blocks="{{ cod_blocks | escape }}"
     data-custom-fields="{{ cod_custom_fields | escape }}"
     data-styles="{{ cod_styles | escape }}"
     data-button-styles="{{ cod_button_styles | escape }}"
     data-button-text-color="{{ btn_styles.textColor | default: '#ffffff' }}"
     data-button-border-color="{{ btn_styles.borderColor | default: cod_primary_color }}"
     data-button-border-width="{{ btn_styles.borderWidth | default: 0 }}"
     data-shipping-options="{{ cod_shipping_options | escape }}"
     data-modal-style="{{ cod_modal_style }}"
     data-anim-style="{{ cod_anim_style }}"
     data-border-radius="{{ cod_border_radius }}"
     data-show-image="{{ cod_show_product_image }}"
     data-show-price="{{ cod_show_price }}"
     data-form-title="{{ cod_form_title }}"
     data-form-subtitle="{{ cod_form_subtitle }}"
     data-partial-cod-enabled="{{ cod_partial_enabled }}"
     data-partial-cod-advance="{{ cod_partial_advance }}">
</div>

{% comment %} Modal Overlay {% endcomment %}
<div class="cod-modal-overlay" id="cod-modal-overlay-{{ product.id }}" style="display: none;">

<div class="cod-form-container cod-modal" 
     id="cod-form-{{ product.id }}"
     style="display: none;">
  
  {% comment %} Close Button {% endcomment %}
  <button type="button" class="cod-close-btn" data-cod-close="{{ product.id }}">&times;</button>

  {% comment %} Product Info {% endcomment %}
  {% if cod_show_product_image == 'true' or cod_show_price == 'true' %}
  <div class="cod-product-info">
    {% if cod_show_product_image == 'true' and product.featured_image %}
      <img src="{{ product.featured_image | image_url: width: 100 }}" 
           alt="{{ product.title }}" 
           class="cod-product-image"
           width="80"
           height="80"
           loading="lazy">
    {% endif %}
    <div class="cod-product-details">
      <h3 class="cod-product-title">{{ product.title }}</h3>
      {% if cod_show_price == 'true' %}
          <p class="cod-product-price" style="color: {{ cod_primary_color }};">{{ product_price }}</p>
      {% endif %}
      {% if current_variant.title != 'Default Title' %}
        <p class="cod-variant-title">{{ current_variant.title }}</p>
      {% endif %}
    </div>
  </div>
  {% endif %}
  
  <div class="cod-form-headers" style="text-align: center; margin-bottom: 16px;">
      {% if cod_form_title != blank %}<h2 style="margin: 0; font-size: 20px;">{{ cod_form_title }}</h2>{% endif %}
      {% if cod_form_subtitle != blank %}<p style="margin: 4px 0 0; color: #666; font-size: 14px;">{{ cod_form_subtitle }}</p>{% endif %}
  </div>

  {% comment %} COD Form - Dynamic Content Rendered by JS {% endcomment %}
  <form id="cod-order-form-{{ product.id }}" class="cod-order-form">
      <div class="cod-dynamic-fields-container">
          <!-- Fields will be injected here by cod-form.js -->
      </div>

    {% comment %} Total Price {% endcomment %}
    <div class="cod-total">
      <span>Total:</span>
      <span class="cod-total-price" data-unit-price="{{ current_variant.price | divided_by: 100.0 }}" style="color: {{ cod_primary_color }};">
        {{ product_price }}
      </span>
    </div>

    {% comment %} Submit Button {% endcomment %}
    <button type="submit" 
            class="cod-submit-btn"
            style="background-color: {{ cod_primary_color }};">
      {{ shop.metafields.fox_cod.submit_button_text | default: 'Place Order (COD)' }}
    </button>

    {% comment %} Status Messages {% endcomment %}
    <div class="cod-message cod-message-success" style="display: none;">
      <svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
      <span class="cod-message-text">Order placed successfully!</span>
    </div>
    <div class="cod-message cod-message-error" style="display: none;">
      <svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>
      <span class="cod-message-text">Something went wrong</span>
    </div>
  </form>
</div>

</div>

<style>
  /* COD Buy Button - styled to match theme buttons */
  .cod-buy-btn {
    width: 100%;
    padding: 14px 20px;
    border: none;
    border-radius: 6px;
    color: #fff;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
    display: block;
    box-sizing: border-box;
  }

  .cod-buy-btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }

  /* Modal Overlay - prevent horizontal swipe/scroll */
  .cod-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9998;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    animation: fadeIn 0.2s ease;
    touch-action: pan-y;
    overflow-x: hidden;
    overscroll-behavior-x: contain;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* Modal Container - prevent horizontal swipe */
  .cod-form-container.cod-modal {
    position: relative;
    z-index: 9999;
    max-height: 90vh;
    overflow-y: auto;
    overflow-x: hidden;
    touch-action: pan-y;
    overscroll-behavior-x: none;
    animation: slideUp 0.3s ease;
  }

  @keyframes slideUp {
    from { 
      opacity: 0;
      transform: translateY(20px);
    }
    to { 
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Close Button */
  .cod-close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 32px;
    height: 32px;
    border: none;
    background: #f5f5f5;
    border-radius: 50%;
    font-size: 24px;
    line-height: 1;
    cursor: pointer;
    color: #666;
    transition: all 0.2s;
  }

  .cod-close-btn:hover {
    background: #e0e0e0;
    color: #333;
  }

  /* Base Container */
  .cod-form-container {
    max-width: 400px;
    padding: 20px;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    background: #fff;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  .cod-product-info {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid #e5e5e5;
  }

  .cod-product-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 6px;
  }

  .cod-product-details {
    flex: 1;
  }

  .cod-product-title {
    margin: 0 0 4px 0;
    font-size: 16px;
    font-weight: 600;
    color: #333;
  }

  .cod-product-price {
    margin: 0;
    font-size: 18px;
    font-weight: 700;
  }

  .cod-variant-title {
    margin: 4px 0 0 0;
    font-size: 13px;
    color: #666;
  }

  .cod-order-form {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .cod-form-field {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .cod-form-field label {
    font-size: 14px;
    font-weight: 500;
    color: #333;
  }

  .cod-form-field .required {
    color: #e53935;
  }

  .cod-form-field input,
  .cod-form-field textarea {
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.2s;
  }

  .cod-form-field input:focus,
  .cod-form-field textarea:focus {
    outline: none;
    border-color: {{ cod_primary_color }};
  }

  .cod-quantity-selector {
    display: flex;
    align-items: center;
    gap: 8px;
    max-width: 140px;
  }

  .cod-qty-btn {
    width: 36px;
    height: 36px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: #f5f5f5;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .cod-qty-btn:hover {
    background: #e0e0e0;
  }

  .cod-quantity-selector input {
    width: 50px;
    text-align: center;
  }

  .cod-total {
    display: flex;
    justify-content: space-between;
    padding: 12px 0;
    border-top: 1px solid #e5e5e5;
    font-size: 16px;
    font-weight: 600;
  }

  .cod-submit-btn {
    width: 100%;
    padding: 14px 20px;
    border: none;
    border-radius: 6px;
    color: #fff;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .cod-submit-btn:hover {
    opacity: 0.9;
  }

  .cod-submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .cod-message {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px;
    border-radius: 6px;
    font-size: 14px;
  }

  .cod-message svg {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }

  .cod-message-success {
    background: #e8f5e9;
    color: #2e7d32;
    touch-action: pan-y;
    overflow-x: hidden;
  }

  .cod-message-error {
    background: #ffebee;
    color: #c62828;
  }

  .cod-submit-btn.loading {
    position: relative;
    color: transparent;
  }

  .cod-submit-btn.loading::after {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    top: 50%;
    left: 50%;
    margin-left: -10px;
    margin-top: -10px;
    border: 2px solid #fff;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spinner 0.8s linear infinite;
  }

  @keyframes spinner {
    to { transform: rotate(360deg); }
  }

  /* Prevent body scroll when modal is open */
  body.cod-modal-open {
    overflow: hidden;
  }
</style>

<style>
  /* Dynamic Styles from Metafields - button_styles sync text color, border, etc. */
  :root {
      --cod-primary: {{ cod_primary_color }};
      --cod-radius: {{ cod_border_radius }}px;
      --cod-btn-size: {% if cod_button_size == 'small' %}10px 20px{% elsif cod_button_size == 'large' %}16px 32px{% else %}14px 28px{% endif %};
      --cod-btn-font: {% if cod_button_size == 'small' %}14px{% elsif cod_button_size == 'large' %}18px{% else %}16px{% endif %};
      --cod-btn-text: {{ btn_styles.textColor | default: '#ffffff' }};
      --cod-btn-border-color: {{ btn_styles.borderColor | default: cod_primary_color }};
      --cod-btn-border-width: {{ btn_styles.borderWidth | default: 0 }}px;
      --cod-btn-radius: {{ btn_styles.borderRadius | default: cod_border_radius }}px;
      --cod-btn-bg: {{ btn_styles.backgroundColor | default: cod_primary_color }};
  }

  /* Base Button Styles - use button_styles for text, border, radius */
  .cod-buy-btn, .cod-submit-btn {
      background-color: var(--cod-btn-bg) !important;
      border-radius: var(--cod-btn-radius) !important;
      padding: var(--cod-btn-size) !important;
      font-size: {{ btn_styles.textSize | default: 15 }}px !important;
      font-weight: {% if btn_styles.fontStyle == 'bold' %}700{% else %}400{% endif %} !important;
      font-style: {% if btn_styles.fontStyle == 'italic' %}italic{% else %}normal{% endif %} !important;
      border: var(--cod-btn-border-width) solid var(--cod-btn-border-color) !important;
      color: var(--cod-btn-text) !important;
      cursor: pointer !important;
      transition: all 0.2s ease !important;
      box-shadow: {% if btn_styles.shadow %}0 4px 6px rgba(0,0,0,0.1){% else %}none{% endif %} !important;
  }

  /* Outline Style */
  {% if cod_button_style == 'outline' %}
  .cod-buy-btn, .cod-submit-btn {
      background-color: transparent !important;
      border: 2px solid var(--cod-btn-border-color) !important;
      color: var(--cod-btn-text) !important;
  }
  .cod-buy-btn:hover, .cod-submit-btn:hover {
      background-color: var(--cod-primary) !important;
      color: var(--cod-btn-text) !important;
  }
  {% endif %}

  /* Gradient Style */
  {% if cod_button_style == 'gradient' %}
  .cod-buy-btn, .cod-submit-btn {
      background-color: var(--cod-primary) !important;
      background-image: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(0,0,0,0.25) 100%) !important;
      box-shadow: {% if btn_styles.shadow %}0 6px 12px -2px rgba(0, 0, 0, 0.2), 0 3px 6px -3px rgba(0, 0, 0, 0.15){% else %}none{% endif %} !important;
  }
  {% endif %}
  
  /* Modal Container Styles */
  .cod-form-container {
      border-radius: var(--cod-radius) !important;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
  }
  
  /* Minimal Style */
  {% if cod_modal_style == 'minimal' %}
  .cod-form-container {
      border: 1px solid #e5e5e5 !important;
      box-shadow: none !important;
  }
  {% endif %}

  /* Glassmorphism Style */
  {% if cod_modal_style == 'glassmorphism' %}
  .cod-form-container {
      background: rgba(255, 255, 255, 0.95) !important;
      backdrop-filter: blur(10px) !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
  }
  .cod-modal-overlay {
      background: rgba(0, 0, 0, 0.3) !important;
      backdrop-filter: blur(4px) !important;
  }
  {% endif %}
  
  .cod-input, .cod-form-field textarea {
      border-radius: 8px !important; 
  }

  .cod-input:focus, .cod-form-field textarea:focus {
      border-color: var(--cod-primary) !important;
      box-shadow: 0 0 0 2px {{ cod_primary_color }}20 !important;
  }

  /* Animation Overrides */
  {% if cod_anim_style == 'scale' %}
  @keyframes slideUp {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
  }
  {% elsif cod_anim_style == 'slide' %}
  @keyframes slideUp {
      from { opacity: 0; transform: translateX(50px); }
      to { opacity: 1; transform: translateX(0); }
  }
  {% endif %}
</style>
<script src="{{ 'cod-form.js' | asset_url }}" defer></script>

{% else %}
{% comment %} COD is disabled - don't render anything {% endcomment %}
{% endif %}
